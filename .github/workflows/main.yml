name: SSH Debug Runner

on:
  workflow_dispatch:

jobs:
  ssh-debug:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install SSH + cloudflared
        run: |
          sudo apt update
          sudo apt install -y openssh-server
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

      - name: Setup SSH
        run: |
          sudo mkdir -p /var/run/sshd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          echo "PasswordAuthentication no" | sudo tee -a /etc/ssh/sshd_config

          sudo useradd -m debug || true
          sudo mkdir -p /home/debug/.ssh
          echo "${{ secrets.SSH_PUBLIC_KEY }}" | sudo tee /home/debug/.ssh/authorized_keys
          sudo chown -R debug:debug /home/debug/.ssh
          sudo chmod 700 /home/debug/.ssh
          sudo chmod 600 /home/debug/.ssh/authorized_keys

          sudo service ssh restart

      - name: Start Cloudflare Tunnel
        run: |
          cloudflared tunnel --no-autoupdate --url ssh://localhost:22
          
